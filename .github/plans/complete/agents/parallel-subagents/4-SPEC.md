# Spec: Parallel Subagent Compatibility for Vibe Flow

## Overview

- Purpose: Define safe orchestration, prompt updates, and task tracking changes so Vibe Flow remains deterministic and auditable when VS Code runs subagents in parallel.
- Goals & success criteria:
  - Preserve auditability in `2-PROGRESS.md` under concurrent subagent activity.
  - Prevent concurrent writes to the same files/plan sections.
  - Support parallel read-only subagents without breaking PDD semantics.
  - Provide clear guidance for response ordering and reconciliation.

## Design

### Architecture

1. **Parallelism policy**
   - Default remains sequential.
   - Parallel execution allowed only for subagents declared **read-only** (no file edits, no `2-PROGRESS.md` updates) or **partitioned** by explicit lock scopes.
   - Any write-capable subagent requires exclusive lock on declared files/sections.

2. **Subagent metadata standard**
   - Each subagent run MUST declare:
     - `subagent-id` (logical ID for audit trail; not necessarily the platform `subAgentInvocationId` but should correlate if visible).
     - `scope`: `read-only` | `write`.
     - `lock-scope`: list of files or plan sections it can edit.
     - `expected-outputs`: list of files to create/update.

3. **Progress log concurrency ledger**
   - Add a “Subagent Ledger” section to `2-PROGRESS.md` with:
     - `subagent-id`
     - `purpose`
     - `lock-scope`
     - `start/end timestamps`
     - `status`
   - Each subagent’s outputs appended under its own heading to reduce interleaving.

4. **Response ordering and reconciliation**
   - Orchestrator must treat parallel responses as unordered. It should:
     - Wait for all subagents in a parallel group to finish.
     - Reconcile in deterministic order (e.g., in the order tasks were assigned in `5-PLAN.md`).
     - Summarize each subagent’s outputs separately before synthesis.

5. **Tool confirmation safety**
   - When parallelism is enabled, enforce that only one subagent can trigger interactive tool confirmations at a time (serial confirmation gating) to prevent misattribution.

### APIs & Interfaces (Prompt/Protocol changes)

- **Orchestrator prompt updates**
  - Add a “Parallel Safety” section with rules:
    - Only launch parallel subagents that declare `read-only` scope.
    - Never allow concurrent edits to `2-PROGRESS.md`.
    - Require a “merge protocol” for any file touched by multiple subagents.

- **Research agent prompt updates**
  - Add “Parallel Mode” instructions:
    - No edits outside its assigned lock-scope.
    - If concurrent with another research agent, append-only in separate headings.

- **PDD protocol update**
  - Add a concurrency metadata block in `2-PROGRESS.md` templates.
  - Define that `2-PROGRESS.md` is single-writer; only orchestrator writes during parallel runs.

## Constraints

- No platform-level isolation for file edits; assume shared workspace.
- Subagent outputs may arrive out of order.
- Tool confirmations may be routed by `subAgentInvocationId`, but must not be relied upon for correctness.

## Acceptance Criteria

- A documented parallelism policy exists and is added to orchestrator and agent prompts.
- `2-PROGRESS.md` gains a concurrency ledger template to keep an auditable trail.
- Guidance clearly states that only read-only tasks can be parallelized by default.
- The orchestrator explicitly handles unordered subagent results.

## Deliverables

- Updated agent prompts:
  - `.github/agents/vibe-flow.agent.md`
  - `.github/agents/research.agent.md`
- Updated documentation:
  - `docs/vibeflow/orchestrator-manual.md`
  - `docs/vibeflow/pdd-protocol.md`
- Updated progress template (if used):
  - `docs/templates/progress-log-template.md`
  - `.github/skills/research/assets/progress-log-template.md`
- New examples for parallel-safe logging and reconciliation (optional).

## Impact Analysis

### Files to Modify

- `.github/agents/vibe-flow.agent.md` — add parallelism policy + reconciliation guidance.
- `.github/agents/research.agent.md` — add parallel-mode guardrails.
- `docs/vibeflow/orchestrator-manual.md` — document parallel subagent model and safe usage.
- `docs/vibeflow/pdd-protocol.md` — add concurrency ledger and single-writer rule.
- `docs/templates/progress-log-template.md` — include subagent ledger example.
- `.github/skills/research/assets/progress-log-template.md` — align with new ledger.

### Files to Create

- None required.

### Breaking Changes

- None, but existing guidance will be stricter about parallel usage.

### Migration Required

- Update existing plan folders if parallel subagents are used; otherwise optional.

---

_Generated by `research` skill._
